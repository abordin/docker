FROM jacksonveroneze/debian-stretch-slim

MAINTAINER Jackson Veroneze <jackson@jacksonveroneze.com>

ENV DEBIAN_FRONTEND noninteractive

RUN wget -O /etc/apt/trusted.gpg.d/php.gpg https://packages.sury.org/php/apt.gpg \
    && echo "deb https://packages.sury.org/php/ $(lsb_release -sc) main" | tee /etc/apt/sources.list.d/php.list \
    && apt-get update \
    && apt-get install --no-install-recommends --no-install-suggests -y \
    php7.1-dev \
    php7.1-cli \
    php7.1-intl \
    php-soap \
    php7.1-json \
    php7.1-curl \
    php7.1-fpm \
    php-pear \
    php7.1-gd \
    php7.1-zip \
    php7.1-pgsql \
    php7.1-mysql \
    php7.1-mcrypt \
    php7.1-mbstring \
    php7.1-memcached \
    php7.1-memcache \
    php7.1-xdebug \
    php7.1-ldap \
    php7.1-imagick \
    php7.1-bcmath \
    php7.1-interbase \
    php-pecl-http \
    && apt-get autoremove -y \
    && apt-get clean \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/*

RUN export XDEBUG_CONFIG="idekey=dbgp" \
    && echo "export XDEBUG_CONFIG=\"idekey=dbgp\"" >> /root/.bashrc \
    && mkdir -p /var/run/php \
    && rm /etc/php/7.1/mods-available/xdebug.ini

RUN sed -i "s/;date.timezone =/date.timezone = America\/Sao_Paulo/" /etc/php/7.1/cli/php.ini \
    && sed -i "s/;date.timezone =/date.timezone = America\/Sao_Paulo/" /etc/php/7.1/fpm/php.ini \
    && sed -i "s/short_open_tag = On/short_open_tag = Off/" /etc/php/7.1/cli/php.ini \
    && sed -i "s/short_open_tag = On/short_open_tag = Off/" /etc/php/7.1/fpm/php.ini \
    && sed -i "s/error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT/error_reporting = E_ALL/" /etc/php/7.1/cli/php.ini \
    && sed -i "s/error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT/error_reporting = E_ALL/" /etc/php/7.1/fpm/php.ini \
    && sed -i "s/display_errors = Off/display_errors = On/" /etc/php/7.1/cli/php.ini \
    && sed -i "s/display_errors = Off/display_errors = On/" /etc/php/7.1/fpm/php.ini \
    && sed -i "s/display_startup_errors = Off/display_startup_errors = On/" /etc/php/7.1/cli/php.ini \
    && sed -i "s/display_startup_errors = Off/display_startup_errors = On/" /etc/php/7.1/fpm/php.ini \
    && sed -i "s/log_errors = Off/log_errors = On/" /etc/php/7.1/cli/php.ini \
    && sed -i "s/log_errors = Off/log_errors = On/" /etc/php/7.1/fpm/php.ini \
    && sed -i "s/upload_max_filesize = 2M/upload_max_filesize = 5000M/" /etc/php/7.1/cli/php.ini \
    && sed -i "s/upload_max_filesize = 2M/upload_max_filesize = 5000M/" /etc/php/7.1/fpm/php.ini \
    && sed -i "s/post_max_size = 8M/post_max_size = 5000M/" /etc/php/7.1/cli/php.ini \
    && sed -i "s/post_max_size = 8M/post_max_size = 5000M/" /etc/php/7.1/fpm/php.ini \
    && sed -i "s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/" /etc/php/7.1/fpm/php.ini \
    && sed -i "s/listen = \/run\/php\/php7\.1\-fpm\.sock/listen = 9000/" /etc/php/7.1/fpm/pool.d/www.conf

ADD shared/xdebug.ini /etc/php/7.1/mods-available
ADD shared/sg-7.1.ini /etc/php/7.1/mods-available/sg.ini
ADD shared/ixed.7.1.lin /usr/lib/php/20160303/ixed.7.1.lin

RUN curl -sS https://getcomposer.org/installer | php \
    && mv composer.phar /usr/local/bin/ \
    && ln -s /usr/local/bin/composer.phar /usr/local/bin/composer \
    && phpenmod sg

EXPOSE 9000

ENTRYPOINT /usr/sbin/php-fpm7.1 --nodaemonize --force-stderr